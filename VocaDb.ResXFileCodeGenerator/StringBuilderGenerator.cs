using System.Globalization;
using System.Resources;
using System.Text;
using System.Text.RegularExpressions;
using System.Web;
using System.Xml;
using System.Xml.Linq;
using Microsoft.CodeAnalysis;

namespace VocaDb.ResXFileCodeGenerator;

public sealed class StringBuilderGenerator : IGenerator
{
	private static readonly Regex ValidMemberNamePattern = new(@"^[\p{L}\p{Nl}_][\p{Cf}\p{L}\p{Mc}\p{Mn}\p{Nd}\p{Nl}\p{Pc}]*$", RegexOptions.Compiled | RegexOptions.CultureInvariant);
	private static readonly Regex InvalidMemberNameSymbols = new(@"[^\p{Cf}\p{L}\p{Mc}\p{Mn}\p{Nd}\p{Nl}\p{Pc}]", RegexOptions.Compiled | RegexOptions.CultureInvariant);

	private static readonly DiagnosticDescriptor DuplicateError = new(id: "VocaDbResXFileCodeGenerator001",
		title: "Duplicate member",
		messageFormat: "Ignored added member '{0}'",
		category: "ResXFileCodeGenerator",
		DiagnosticSeverity.Warning,
		isEnabledByDefault: true);

	private static readonly DiagnosticDescriptor MemberSameAsClassError = new(id: "VocaDbResXFileCodeGenerator002",
		title: "Member same name as class",
		messageFormat: "Ignored member '{0}' has same name as class",
		category: "ResXFileCodeGenerator",
		DiagnosticSeverity.Warning,
		isEnabledByDefault: true);

	public string Generate(Stream resxStream, GeneratorOptions options)
	{
		// HACK: netstandard2.0 doesn't support improved interpolated strings?
		var builder = new StringBuilder();

		builder.AppendLine(Constants.AutoGeneratedHeader);
		builder.AppendLine("#nullable enable");

		builder.Append("namespace ");
		builder.AppendLine(options.CustomToolNamespace ?? options.LocalNamespace);
		builder.AppendLine("{");

		builder.Append("    using ");
		builder.Append(Constants.SystemGlobalization);
		builder.AppendLine(";");

		builder.Append("    using ");
		builder.Append(Constants.SystemResources);
		builder.AppendLine(";");

		builder.AppendLine();

		builder.Append("    ");
		builder.Append(options.PublicClass ? "public" : "internal");
		builder.Append(options.StaticClass ? " static class " : " class ");
		builder.AppendLine(options.ClassName);
		builder.AppendLine("    {");

		builder.Append("        private static ");
		builder.Append(nameof(ResourceManager));
		builder.Append("? ");
		builder.Append(Constants.s_resourceManagerVariable);
		builder.AppendLine(";");

		builder.Append("        public static ");
		builder.Append(nameof(ResourceManager));
		builder.Append(" ");
		builder.Append(Constants.ResourceManagerVariable);
		builder.Append(" => ");
		builder.Append(Constants.s_resourceManagerVariable);
		builder.Append(" ??= new ");
		builder.Append(nameof(ResourceManager));
		builder.Append("(\"");
		builder.Append(options.LocalNamespace);
		builder.Append(".");
		builder.Append(options.ClassName);
		builder.Append("\", typeof(");
		builder.Append(options.ClassName);
		builder.AppendLine(").Assembly);");

		builder.Append("        public static ");
		builder.Append(nameof(CultureInfo));
		builder.Append("? ");
		builder.Append(Constants.CultureInfoVariable);
		builder.AppendLine(" { get; set; }");

		builder.AppendLine();

		static void CreateMember(StringBuilder builder, GeneratorOptions options, string name, string value,
			int line, HashSet<string> alreadyAddedMembers)
		{
			string memberName;
			bool resourceAccessByName;

			if (ValidMemberNamePattern.IsMatch(name))
			{
				memberName = name;
				resourceAccessByName = true;
			}
			else
			{
				memberName = InvalidMemberNameSymbols.Replace(name, "_");
				resourceAccessByName = false;
			}

			if (!alreadyAddedMembers.Add(memberName))
			{
				options.ReportError?.Invoke(Diagnostic.Create(DuplicateError, Location.Create(options.FilePath!, new(), new(new(line, 14), new (line,14+memberName.Length))), memberName));
				return;
			}
			if (memberName == options.ClassName)
			{
				options.ReportError?.Invoke(Diagnostic.Create(MemberSameAsClassError, Location.Create(options.FilePath!, new(), new(new(line, 14), new (line,14+memberName.Length))), memberName));
				return;
			}
			builder.AppendLine("        /// <summary>");

			builder.Append("        /// Looks up a localized string similar to ");
			builder.Append(HttpUtility.HtmlEncode(value.Trim().Replace("\r\n", "\n").Replace("\r", "\n").Replace("\n", Environment.NewLine + "        /// ")));
			builder.AppendLine(".");

			builder.AppendLine("        /// </summary>");

			builder.Append("        public static string");
			builder.Append(options.NullForgivingOperators ? null : "?");
			builder.Append(" ");
			builder.Append(memberName);

			if (resourceAccessByName)
			{
				builder.Append(" => ResourceManager.GetString(nameof(");
				builder.Append(name);
				builder.Append("), ");
			}
			else
			{
				builder.Append(@" => ResourceManager.GetString(""");
				builder.Append(name.Replace(@"""", @"\"""));
				builder.Append(@""", ");
			}
			builder.Append(Constants.CultureInfoVariable);
			builder.Append(")");
			builder.Append(options.NullForgivingOperators ? "!" : null);
			builder.AppendLine(";");
		}

		if (XDocument.Load(resxStream, LoadOptions.SetLineInfo).Root is XElement element)
		{
			var members = element
				.Descendants()
				.Where(static data => data.Name == "data")
				.Select(static data => (data.Attribute("name")!.Value, data.Descendants("value").First().Value, (data as IXmlLineInfo).LineNumber-1));

			HashSet<string> alreadyAddedMembers = new();
			foreach (var ((key, value, line), index) in members.Select((kv, index) => (kv, index)))
			{
				if (index > 0) builder.AppendLine();

				CreateMember(builder, options, key, value, line, alreadyAddedMembers);
			}
		}

		builder.AppendLine("    }");

		builder.Append("}");

		return builder.ToString();
	}
}
